# Go Chat - Чат с чистой архитектурой и WebSocket

Проект чата на Go с использованием чистой архитектуры и встроенного WebSocket сервера для real-time обмена сообщениями.

## Архитектура

Проект следует принципам чистой архитектуры с использованием `internal` пакета для приватных компонентов:

```
gochat/
├── internal/        # Приватные компоненты приложения
│   ├── domain/      # Доменные сущности и интерфейсы репозиториев
│   ├── repository/ # Реализации репозиториев (in-memory)
│   ├── usecase/    # Бизнес-логика
│   └── delivery/   # HTTP handlers и WebSocket сервер
├── cmd/server/      # Точка входа сервера
├── client/          # CLI клиент
└── Makefile         # Команды для запуска и сборки
```

## Требования

- Go 1.21 или выше

## Быстрый старт

```bash
# 1. Установить зависимости
make deps

# 2. Запустить сервер (в первом терминале)
make server

# 3. Запустить клиент (во втором терминале)
make client
```

## Настройка

### Переменные окружения для сервера

```bash
# Порт сервера (по умолчанию: 8080)
export PORT=8080

# Хост для прослушивания (по умолчанию: 0.0.0.0 - все интерфейсы)
export HOST=0.0.0.0
```

### Переменные окружения для клиента

```bash
# Адрес сервера (по умолчанию: http://localhost:8080)
export SERVER_URL=http://192.168.1.100:8080
```

### Запуск с параметрами

```bash
# Сервер
make server PORT=3000 HOST=0.0.0.0

# Клиент (подключение к удаленному серверу)
make client SERVER_URL=http://192.168.1.100:8080
```

## Команды Makefile

```bash
make help          # Показать справку
make deps           # Установить зависимости
make server         # Запустить сервер
make client         # Запустить клиент
make build          # Собрать сервер и клиент
make test           # Запустить тесты
make test-coverage  # Запустить тесты с покрытием
make clean          # Очистить собранные файлы
```

## API Endpoints

### Пользователи

- `POST /api/users/register` - Регистрация пользователя
  ```json
  {
    "username": "john_doe"
  }
  ```

- `GET /api/users/get?id={user_id}` - Получение пользователя по ID

### Комнаты

- `POST /api/rooms/create` - Создание комнаты
  ```json
  {
    "name": "General"
  }
  ```

- `GET /api/rooms/get?id={room_id}` - Получение комнаты по ID
- `GET /api/rooms/all` - Получение всех комнат

### Сообщения

- `POST /api/messages/send?room_id={room_id}&user_id={user_id}` - Отправка сообщения
  ```json
  {
    "content": "Hello, world!"
  }
  ```

- `GET /api/messages/history?room_id={room_id}&limit=50&offset=0` - Получение истории сообщений

### WebSocket

- `GET /ws?room_id={room_id}&user_id={user_id}` - Подключение к WebSocket для real-time сообщений

## Использование по сети

Сервер по умолчанию слушает на всех интерфейсах (`0.0.0.0`), что позволяет подключаться с других компьютеров в сети.

### Определение IP адреса сервера

```bash
# Windows
ipconfig

# Linux/Mac
ip addr show
```

### Подключение клиента к удаленному серверу

```bash
# Windows PowerShell
$env:SERVER_URL="http://192.168.1.100:8080"
make client

# Linux/Mac
SERVER_URL=http://192.168.1.100:8080 make client
```

## Команды клиента

После запуска клиента доступны следующие команды:

- `/rooms` - Показать все комнаты
- `/create <name>` - Создать новую комнату
- `/join <number>` - Присоединиться к комнате по номеру
- `/leave` - Покинуть текущую комнату
- `/history [limit]` - Показать историю сообщений (по умолчанию: 10)
- `/help` - Показать справку
- `/exit` - Выйти из приложения

## Тестирование

```bash
# Запустить все тесты
make test

# Запустить тесты с покрытием
make test-coverage
```

## Структура проекта

### Domain Layer (`internal/domain`)
- Определяет сущности: `User`, `Message`, `Room`
- Определяет интерфейсы репозиториев

### Repository Layer (`internal/repository`)
- In-memory реализации репозиториев
- Потокобезопасные операции

### Usecase Layer (`internal/usecase`)
- Бизнес-логика приложения
- Валидация данных
- Координация между репозиториями

### Delivery Layer (`internal/delivery`)
- HTTP handlers для REST API
- Встроенный WebSocket сервер для real-time сообщений
- DTO для запросов и ответов

### Client (`client/`)
- CLI клиент для подключения к чату
- Подписка на комнаты через WebSocket
- Отправка и получение сообщений в реальном времени

## Особенности

- ✅ Чистая архитектура с разделением слоев
- ✅ Real-time обмен сообщениями через встроенный WebSocket сервер
- ✅ In-memory хранилище (можно легко заменить на БД)
- ✅ Потокобезопасные операции
- ✅ Тесты для usecase и repository слоев
- ✅ CLI клиент для тестирования
- ✅ Не требует внешних зависимостей (только Go)
- ✅ Работа по сети из коробки

## Лицензия

MIT
